<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Tasky ‚Äî Calendar</title>
<link href="https://fonts.cdnfonts.com/css/amsterdam-four" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<style>
  body {
    margin: 0;
    min-height: 100vh;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, rgba(255,215,0,0.6), rgba(30,144,255,0.7));
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 40px 0;
  }
  .container {
    background: rgba(255,255,255,0.9);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    width: 90%;
    max-width: 1000px;
  }
  h1 {
    font-family: 'Amsterdam Four', cursive;
    margin: 0 0 20px 0;
    color: #1c2833;
    text-align: center;
  }
  button {
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    background: linear-gradient(90deg, #007bff, #ffd700);
    color: white;
    cursor: pointer;
    margin: 5px;
  }
  button:hover { opacity: 0.9; transform: scale(1.05); }
</style>
</head>
<body>
  <div class="container">
    <h1>üìÖ My Task Calendar</h1>
    <div id="calendar"></div>
    <div style="text-align:center;margin-top:20px;">
      <button onclick="back()">‚Üê Back to Tasks</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

<script>
const currentUser = localStorage.getItem('currentUser');
if (!currentUser || currentUser === 'admin') location.href = 'index.html';

// Load users & tasks
const users = JSON.parse(localStorage.getItem('users') || '{}');
if (!users[currentUser]) users[currentUser] = { tasks: [] };
const tasks = users[currentUser].tasks;

// Save changes
function saveTasks() {
  users[currentUser].tasks = tasks;
  localStorage.setItem('users', JSON.stringify(users));
}

// Helper: add one day (for inclusive end date rendering)
function addOneDay(dateStr) {
  const d = new Date(dateStr);
  d.setDate(d.getDate() + 1);
  return d.toISOString().split('T')[0];
}

// Initialize calendar
document.addEventListener('DOMContentLoaded', () => {
  const calEl = document.getElementById('calendar');
  const cal = new FullCalendar.Calendar(calEl, {
    initialView: 'dayGridMonth',
    height: 'auto',
    selectable: true,
    editable: true,
    selectMirror: true,
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,listWeek'
    },

    // üü¢ Add new task by selecting range
    select: (info) => {
      const title = prompt('Enter task title:');
      if (title) {
        const newTask = {
          text: title.trim(),
          startDate: info.startStr,
          endDate: info.endStr ? new Date(new Date(info.endStr).getTime() - 86400000).toISOString().split('T')[0] : info.startStr, // make inclusive
          completed: false
        };
        tasks.push(newTask);
        saveTasks();

        cal.addEvent({
          title: title,
          start: newTask.startDate,
          end: addOneDay(newTask.endDate),
          color: '#f39c12'
        });
      }
      cal.unselect();
    },

    // üü° Click to edit/delete/complete
    eventClick: (info) => {
      const task = tasks.find(t => 
        t.text === info.event.title.replace(' ‚úÖ','') && 
        addOneDay(t.endDate) === info.event.endStr && 
        t.startDate === info.event.startStr
      );
      if (!task) return;

      const action = prompt(`Task: ${task.text}\n\n1. Edit\n2. Delete\n3. Toggle Complete`, "1");
      if (action === null) return;

      switch (action.trim()) {
        case "1": {
          const newTitle = prompt("Edit task title:", task.text);
          if (newTitle && newTitle.trim()) {
            task.text = newTitle.trim();
            info.event.setProp("title", newTitle + (task.completed ? " ‚úÖ" : ""));
          }
          break;
        }
        case "2": {
          if (confirm(`Delete "${task.text}"?`)) {
            const idx = tasks.indexOf(task);
            if (idx > -1) tasks.splice(idx, 1);
            info.event.remove();
          }
          break;
        }
        case "3": {
          task.completed = !task.completed;
          info.event.setProp("title", task.text + (task.completed ? " ‚úÖ" : ""));
          info.event.setProp("color", task.completed ? "#27ae60" : "#f39c12");
          break;
        }
      }
      task.lastUpdated = new Date().toISOString();
      saveTasks();
    },

    // üîµ Drag or resize events to update task dates
    eventDrop: updateTaskDates,
    eventResize: updateTaskDates,

    // üóì Load tasks into calendar with inclusive end date
    events: tasks
      .filter(t => t.startDate)
      .map(t => ({
        title: t.text + (t.completed ? ' ‚úÖ' : ''),
        start: t.startDate,
        end: addOneDay(t.endDate || t.startDate), // inclusive
        color: t.completed ? '#27ae60' : '#f39c12'
      }))
  });

  cal.render();

  // Function to update when event dragged/resized
  function updateTaskDates(info) {
    const task = tasks.find(t =>
      t.text === info.event.title.replace(' ‚úÖ','')
    );
    if (task) {
      task.startDate = info.event.startStr;
      task.endDate = new Date(new Date(info.event.endStr).getTime() - 86400000)
        .toISOString().split('T')[0]; // subtract one day to make inclusive
      task.lastUpdated = new Date().toISOString();
      saveTasks();
    }
  }
});

function back() { location.href = 'tasky.html'; }
function logout() { localStorage.removeItem('currentUser'); location.href = 'index.html'; }
</script>
</body>
</html>
